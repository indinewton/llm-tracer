# Justfile for LLM Tracer Service

# Configuration - override via environment variable if needed
aws_region := env_var_or_default("AWS_REGION", "eu-central-1")

# Show essential commands
help:
    @echo "LLM Tracer - Essential Commands"
    @echo "================================"
    @echo ""
    @echo "Getting Started:"
    @echo "  just up          Start all services (DynamoDB + API)"
    @echo "  just down        Stop all services"
    @echo "  just logs        View API service logs"
    @echo "  just status      Check service status"
    @echo ""
    @echo "Testing:"
    @echo "  just health      Test health endpoint"
    @echo "  just test-trace  Create a test trace"
    @echo "  just traces      List all traces"
    @echo ""
    @echo "Database:"
    @echo "  just reset-tables  Reset DynamoDB tables"
    @echo "  just list-tables   List DynamoDB tables"
    @echo ""
    @echo "Run 'just --list' to see all available commands."

# List all available commands
list:
    @just --list

# ==================
# Docker Commands
# ==================

# Start all services (DynamoDB + API)
up:
    docker-compose up -d dynamodb
    @echo "Waiting for DynamoDB to be ready..."
    @sleep 3
    @just create-tables
    docker-compose up -d service
    @echo "Waiting for service to start..."
    @sleep 2
    @echo "Services ready at http://localhost:8001"

# Stop all services
down:
    docker-compose down
    @echo "Services stopped."

# Restart all services
restart:
    @just down
    @just up

# Stop all services, rebuild images and restart
rebuild-service:
    @just down
    @docker-compose build --no-cache service
    @just up

# View service logs
logs:
    docker-compose logs -f service

# View DynamoDB logs
logs-dynamodb:
    docker-compose logs -f dynamodb

# Check service status
status:
    docker-compose ps

# Clean everything (containers, volumes, images)
clean:
    docker-compose down -v
    docker rmi llm-tracer:latest 2>/dev/null || true
    @echo "Cleaned up containers, volumes, and images."

# ==================
# DynamoDB Commands
# ==================

# Create DynamoDB tables (uses local python, not container)
create-tables:
    uv run python scripts/create_dynamodb_tables.py --endpoint http://localhost:8000

# List DynamoDB tables
list-tables:
    aws dynamodb list-tables --endpoint-url http://localhost:8000 --region {{aws_region}}

# Scan traces table
scan-traces:
    aws dynamodb scan --table-name llm-tracer-dev-traces --endpoint-url http://localhost:8000 --region {{aws_region}}

# Scan spans table
scan-spans:
    aws dynamodb scan --table-name llm-tracer-dev-spans --endpoint-url http://localhost:8000 --region {{aws_region}}

# Delete and recreate tables (reset data)
reset-tables:
    aws dynamodb delete-table --table-name llm-tracer-dev-traces --endpoint-url http://localhost:8000 --region {{aws_region}} 2>/dev/null || true
    aws dynamodb delete-table --table-name llm-tracer-dev-spans --endpoint-url http://localhost:8000 --region {{aws_region}} 2>/dev/null || true
    @sleep 2
    @just create-tables
    @echo "Tables reset."

# ==================
# API Test Commands
# ==================

# Test health endpoint
health:
    curl -s http://localhost:8001/health | python -m json.tool

# List all traces
traces:
    curl -s -H "X-API-Key: project-dev" http://localhost:8001/api/traces | python -m json.tool

# Get stats
stats:
    curl -s -H "X-API-Key: project-dev" http://localhost:8001/api/stats | python -m json.tool

# Create a test trace
test-trace:
    curl -s -X POST http://localhost:8001/api/traces \
      -H "Content-Type: application/json" \
      -H "X-API-Key: project-dev" \
      -d '{"name": "test-trace", "project_id": "dev", "tags": ["test"]}' | python -m json.tool
