# Base configuration shared between all environments
services:
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: llm-tracer-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"
    healthcheck:
      test: ["CMD", "bash", "-c", "</dev/tcp/localhost/8000"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - llm-tracer
    
  service:
    build:
      context: .
      dockerfile: Dockerfile
    image: llm-tracer:${IMAGE_TAG:-latest}
    environment:
      STORAGE_TYPE: dynamodb
      DYNAMODB_ENDPOINT_URL: http://dynamodb:8000
      DYNAMODB_TRACES_TABLE: ${DYNAMODB_TRACES_TABLE:-llm-tracer-dev-traces}
      DYNAMODB_SPANS_TABLE: ${DYNAMODB_SPANS_TABLE:-llm-tracer-dev-spans}
      AWS_REGION: ${AWS_REGION:-eu-central-1}
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_SESSION_TOKEN: ""
      # if you have aws credentials in shell - below will not work.
      # AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-test}
      # AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-test}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_KEY_REQUIRED: ${API_KEY_REQUIRED:-true}
      API_KEYS: ${API_KEYS:-project-dev}
    ports:
      - "8001:8001"
    depends_on:
      dynamodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8001/health\", timeout=2)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - llm-tracer

networks:
  llm-tracer:
    name: llm-tracer-network-${ENVIRONMENT:-dev}
    driver: bridge