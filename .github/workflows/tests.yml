name: Tests

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

jobs:
    unit-tests:
        runs-on: ubuntu-latest
        
        steps:
            - uses: actions/checkout@v4
            
            - name: Set up python
              uses: actions/setup-python@v5
              with:
                python-version: '3.12'
            
            - name: Install UV
              uses: astral-sh/setup-uv@v4

            - name: Cache UV dependencies
              uses: actions/cache@v4
              with:
                path: ~/.cache/uv
                key: ${{ runner.os }}-uv-${{ hashFiles('service/uv.lock') }}
                restore-keys: |
                    ${{ runner.os }}-uv-
            
            - name: Install dependencies
              run: |
                cd service
                uv sync
            
            - name: Run unit tests
              run: |
                cd service
                uv run pytest tests/unit/ -v --cov=src --cov-report=xml
            
            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                file: ./service/coverage.xml
        
    integration-tests:
        runs-on: ubuntu-latest
        
        services:
            dynamodb:
                image: amazon/dynamodb-local:latest
                ports:
                    - 8000:8000
            
        steps:
            - uses: actions/checkout@v4
        
            - name: Set up python
              uses: actions/setup-python@v5
              with:
                python-version: '3.12'
            
            - name: Install UV
              uses: astral-sh/setup-uv@v4
            
            - name: Cache UV dependencies
              uses: actions/cache@v4
              with:
                path: ~/.cache/uv
                key: ${{ runner.os }}-uv-${{ hashFiles('service/uv.lock') }}
                restore-keys: |
                    ${{ runner.os }}-uv-
            
            - name: Install dependencies
              run: |
                cd service
                uv sync
            
            - name: Create DynamoDB tables
              run: |
                cd service
                uv run python -m scripts.create_dynamodb_tables --endpoint http://localhost:8000
            
            - name: Run integration tests
              env:
                DYNAMODB_ENDPOINT_URL: http://localhost:8000
                DYNAMODB_TRACES_TABLE: llm-tracer-dev-traces
                DYNAMODB_SPANS_TABLE: llm-tracer-dev-spans
                AWS_ACCESS_KEY_ID: test
                AWS_SECRET_ACCESS_KEY: test
                AWS_REGION: eu-central-1
              run: |
                cd service
                uv run pytest tests/integration/ -v
    
    client-tests:
        runs-on: ubuntu-latest
        
        steps:
            - uses: actions/checkout@v4
            
            - name: Set up python
              uses: actions/setup-python@v5
              with:
                python-version: '3.12'
            
            - name: Install UV
              uses: astral-sh/setup-uv@v4
            
            - name: Cache UV dependencies
              uses: actions/cache@v4
              with:
                path: ~/.cache/uv
                key: ${{ runner.os }}-uv-client-${{ hashFiles('client/uv.lock') }}
                restore-keys: |
                    ${{ runner.os }}-uv-client-
            
            - name: Install dependencies
              run: |
                cd client
                uv sync
            
            - name: Run client tests
              run: |
                cd client
                uv run pytest tests/ -v